<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»é»ç¶ æ’ç­æˆ°ç•¥ç³»çµ± v9.6 (BI Edition)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; color: #334155; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* æ²è»¸èˆ‡å®¹å™¨ */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .matrix-container { overflow: auto; height: 85vh; background: white; border: 1px solid #e2e8f0; }
        
        /* Matrix View */
        .matrix-table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 0.75rem; }
        .matrix-table th, .matrix-table td { border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; padding: 4px 8px; white-space: nowrap; text-align: center; height: 32px; }
        .matrix-table thead th { background-color: #f8fafc; position: sticky; top: 0; z-index: 20; font-weight: 700; color: #475569; }
        .matrix-table td:first-child, .matrix-table th:first-child { position: sticky; left: 0; background-color: #fff; z-index: 30; font-weight: 700; text-align: left; border-right: 2px solid #64748b; color: #1e293b; }
        .matrix-table th:first-child { z-index: 40; background-color: #f1f5f9; }
        
        /* Visuals */
        .shilin-bg { background-color: #f0fdf4 !important; }
        .station-divider { border-top: 3px solid #334155 !important; }

        /* Kanban */
        .kanban-col { flex: 1; min-width: 300px; background: #f8fafc; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #e2e8f0; }
        .shift-card { font-size: 0.75rem; padding: 4px 8px; margin-bottom: 4px; background: white; border-radius: 6px; border-left: 4px solid #cbd5e1; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.1s; position: relative; }
        .shift-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .shift-leave { opacity: 0.6; text-decoration: line-through; background-color: #fef2f2; border-left-color: #ef4444; }
        .shift-has-sales { border-right: 4px solid #f59e0b; }

        /* PK Colors (Expanded to 8) */
        .pk-0 { background-color: #fef2f2 !important; color: #b91c1c; border-left-color: #ef4444 !important; } /* Red */
        .pk-1 { background-color: #fffbeb !important; color: #92400e; border-left-color: #f59e0b !important; } /* Amber */
        .pk-2 { background-color: #f0fdf4 !important; color: #166534; border-left-color: #22c55e !important; } /* Green */
        .pk-3 { background-color: #eff6ff !important; color: #1e40af; border-left-color: #3b82f6 !important; } /* Blue */
        .pk-4 { background-color: #faf5ff !important; color: #6b21a8; border-left-color: #a855f7 !important; } /* Purple */
        .pk-5 { background-color: #fdf2f8 !important; color: #9d174d; border-left-color: #ec4899 !important; } /* Pink */
        .pk-6 { background-color: #ecfeff !important; color: #0e7490; border-left-color: #06b6d4 !important; } /* Cyan */
        .pk-7 { background-color: #f7fee7 !important; color: #3f6212; border-left-color: #84cc16 !important; } /* Lime */

        /* Print */
        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; }
            .no-print { display: none !important; }
        }
        
        .print-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; font-size: 0.8rem; }
        .print-day { border: 1px solid #e2e8f0; height: 60px; padding: 2px; display: flex; flex-direction: column; justify-content: space-between; }

        [v-cloak] { display: none; }
        
        /* Modal Transitions */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app" v-cloak class="h-screen flex flex-col">

    <header class="h-14 bg-slate-900 text-white flex items-center justify-between px-4 shadow-md z-50 shrink-0 no-print">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-gradient-to-br from-amber-400 to-orange-600 rounded flex items-center justify-center font-bold text-white shadow-lg">v9.6</div>
                <h1 class="font-bold text-lg hidden md:block">æ’ç­æˆ°ç•¥ç³»çµ± <span class="text-[10px] text-slate-400 font-normal">BI Edition</span></h1>
            </div>
            
            <div class="bg-slate-800 p-1 rounded flex gap-1">
                <button @click="currentView='kanban'" :class="navClass('kanban')" class="px-3 py-1 text-xs rounded transition"><i class="fa-solid fa-columns"></i> çœ‹æ¿</button>
                <button @click="currentView='matrix'" :class="navClass('matrix')" class="px-3 py-1 text-xs rounded transition"><i class="fa-solid fa-table-cells"></i> ç¸½è¡¨</button>
                <button @click="currentView='analysis'" :class="navClass('analysis')" class="px-3 py-1 text-xs rounded transition"><i class="fa-solid fa-chart-line"></i> ç‡Ÿé‹åˆ†æ</button>
                <button @click="currentView='vendor'" :class="navClass('vendor')" class="px-3 py-1 text-xs rounded transition"><i class="fa-solid fa-store"></i> å» å•†ç®¡ç†</button>
                <button @click="currentView='settings'" :class="navClass('settings')" class="px-3 py-1 text-xs rounded transition"><i class="fa-solid fa-toolbox"></i> è³‡æ–™å·¥å…·</button>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button @click="showPKModal = true" class="relative bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1 rounded text-xs font-bold shadow transition">
                <i class="fa-solid fa-people-arrows"></i> PKæˆ°æƒ…å®¤
                <span v-if="pkList.length > 0" class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center">{{pkList.length}}</span>
            </button>

            <div class="flex items-center gap-2 text-xs border-l border-slate-700 pl-3">
                <span v-if="isSaving" class="text-amber-400"><i class="fa-solid fa-circle-notch fa-spin"></i> åŒæ­¥ä¸­</span>
                <span v-else class="text-emerald-400"><i class="fa-solid fa-cloud-check"></i> å·²åŒæ­¥</span>
            </div>
            
            <button @click="showInput = !showInput" class="text-slate-400 hover:text-white" title="åŒ¯å…¥ CSV"><i class="fa-solid fa-file-import"></i></button>
        </div>
    </header>

    <transition name="fade">
        <div v-if="showPKModal" class="fixed inset-0 bg-slate-900/80 z-[70] flex items-center justify-center p-4 no-print" @click.self="showPKModal = false">
            <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden">
                <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                    <h3 class="font-bold text-slate-800">PK æˆ°æƒ…å®¤é¸å–® (æœ€å¤š8å®¶)</h3>
                    <button @click="showPKModal = false" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="p-4 max-h-[60vh] overflow-y-auto custom-scroll">
                    <div class="grid grid-cols-2 gap-2">
                        <label v-for="v in vendorList" :key="v.id" class="flex items-center p-2 border rounded cursor-pointer hover:bg-slate-50 select-none" :class="{'bg-indigo-50 border-indigo-300': pkList.includes(v.id)}">
                            <input type="checkbox" :value="v.id" v-model="pkList" :disabled="pkList.length >= 8 && !pkList.includes(v.id)" class="mr-2">
                            <span class="text-sm truncate">{{ v.displayName }}</span>
                            <span v-if="pkList.includes(v.id)" class="ml-auto w-3 h-3 rounded-full" :class="getPKColorClass(v.id, true)"></span>
                        </label>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 border-t flex justify-between items-center">
                    <span class="text-xs text-slate-500">å·²é¸æ“‡ {{ pkList.length }} / 8</span>
                    <button @click="pkList = []" class="text-xs text-red-500 hover:underline">æ¸…ç©ºé¸æ“‡</button>
                </div>
            </div>
        </div>
    </transition>

    <main class="flex-grow p-4 overflow-hidden relative">

        <div v-if="currentView === 'kanban'" class="h-full flex gap-3 overflow-x-auto pb-2">
            <div v-for="drawer in drawers" :key="drawer.key" class="kanban-col shadow-sm">
                <div class="p-3 border-b bg-white flex justify-between items-center sticky top-0 z-10">
                    <div class="flex items-center gap-2"><div class="w-1.5 h-6 rounded-full" :class="drawer.colorClass"></div><span class="font-bold text-slate-700">{{ drawer.name }}å€</span></div>
                    <div class="text-[10px] text-slate-400 border rounded px-1">{{ getDrawerShiftCount(drawer.key) }}å ´</div>
                </div>
                <div class="overflow-y-auto custom-scrollbar flex-grow p-2 sync-scroll-target" @scroll="handleSyncScroll">
                    <div v-for="week in calendarWeeks" :key="week.id" class="mb-2">
                        <div v-if="week.isMonthStart" class="text-[11px] font-bold text-slate-500 bg-slate-100 py-1 px-2 rounded mb-2 shadow-sm sticky top-0 z-0">{{ week.monthLabel }}</div>
                        <div class="grid grid-cols-5 gap-1">
                            <div v-for="day in week.days" :key="day.dateStr" class="min-h-[80px] bg-white border border-slate-200 rounded p-1 hover:bg-slate-50 relative group">
                                <div class="text-[10px] text-slate-400 mb-1 flex justify-between border-b pb-1">
                                    <span :class="{'text-emerald-600 font-bold': day.isToday}">{{ day.dayNum }}</span>
                                    <span>{{ day.weekday }}</span>
                                </div>
                                <div v-for="shift in getShifts(day.dateStr, drawer.key)" :key="shift.id" 
                                     class="shift-card" 
                                     :class="[getPKColorClass(shift.vendorId), shift.status === 'leave' ? 'shift-leave' : '', shift.sales > 0 ? 'shift-has-sales' : '']" 
                                     @click="openShiftDetail(shift)">
                                    <div class="font-bold truncate">{{ truncateName(getDisplayStaff(shift)) }}</div>
                                    <div v-if="shift.sales > 0" class="text-[9px] text-amber-600 font-mono mt-0.5">${{shift.sales}}</div>
                                    <div v-if="shift.timeAdjustment" class="text-[9px] text-purple-600 mt-0.5">{{shift.timeAdjustment}}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="h-10"></div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'matrix'" class="matrix-container custom-scrollbar rounded-lg shadow-sm">
            <table class="matrix-table">
                <thead>
                    <tr>
                        <th class="w-32 bg-slate-50">ç«™å \ æ—¥æœŸ</th>
                        <th v-for="header in matrixHeaders" :key="header.date" class="min-w-[40px]">
                            <div class="font-bold text-slate-600">{{ header.simpleDate }}</div>
                            <div class="text-[9px] font-normal text-slate-400">{{ header.dayName }}</div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <template v-for="(group, gIndex) in matrixGroups" :key="group.name">
                        <tr v-for="(row, rIndex) in group.rows" :key="row.station" 
                            :class="[gIndex % 2 === 0 ? 'bg-white' : 'bg-slate-50', rIndex === 0 && gIndex !== 0 ? 'station-divider' : '', row.isShilin ? 'shilin-bg' : '']">
                            <td>
                                <div class="flex items-center justify-between">
                                    <span>{{ row.station }}</span>
                                    <span v-if="rIndex === 0" class="text-[9px] px-1 rounded text-white font-bold" :class="group.badgeClass">{{ group.name }}</span>
                                </div>
                            </td>
                            <td v-for="(cell, i) in row.cells" :key="i" :class="getPKColorClass(cell?.vendorId)" @click="cell?.shift ? openShiftDetail(cell.shift) : null" class="cursor-pointer hover:brightness-95 transition">
                                <span :class="{'line-through text-slate-300': cell?.status === 'leave'}">{{ cell?.name }}</span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <div v-if="currentView === 'analysis'" class="h-full bg-white rounded-lg shadow overflow-hidden flex flex-col">
            <div class="p-4 bg-slate-800 text-white shrink-0 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-slate-400">ç¸½é ä¼°ç§Ÿé‡‘ (P1: 11-1æœˆ)</div>
                    <div class="text-2xl font-bold text-emerald-400 font-mono">${{ financialSummary.p1Total.toLocaleString() }}</div>
                </div>
                <div class="bg-slate-700 p-3 rounded-lg">
                    <div class="text-xs text-slate-400">ç¸½é ä¼°ç§Ÿé‡‘ (P2: 2-4æœˆ)</div>
                    <div class="text-2xl font-bold text-emerald-400 font-mono">${{ financialSummary.p2Total.toLocaleString() }}</div>
                </div>
                <div class="bg-slate-700 p-3 rounded-lg flex items-center justify-between">
                    <div>
                        <div class="text-xs text-slate-400">æˆé•·ç‡</div>
                        <div class="text-xl font-bold" :class="financialSummary.growth >= 0 ? 'text-green-400' : 'text-red-400'">{{ financialSummary.growth }}%</div>
                    </div>
                    <div class="text-right text-[10px] text-slate-400">
                        *è¦å‰‡: 20å ´(85æŠ˜), 10å ´(9æŠ˜)<br>æ¯ä¸‰å€‹æœˆç‚ºä¸€æœŸ
                    </div>
                </div>
            </div>

            <div class="flex border-b bg-slate-50 px-4">
                <button @click="analysisTab='rent'" :class="analysisTab==='rent'?'border-indigo-500 text-indigo-600':'border-transparent text-slate-500'" class="px-4 py-2 text-sm border-b-2 font-medium">ç§Ÿé‡‘å ±è¡¨</button>
                <button @click="analysisTab='strategy'" :class="analysisTab==='strategy'?'border-indigo-500 text-indigo-600':'border-transparent text-slate-500'" class="px-4 py-2 text-sm border-b-2 font-medium">ç­–ç•¥åˆ†æ (è¦å¾‹/ç›¸è¥¯)</button>
            </div>

            <div class="overflow-auto p-4 custom-scrollbar flex-grow bg-white">
                <table v-if="analysisTab==='rent'" class="w-full text-xs text-left border-collapse">
                    <thead class="bg-slate-100 sticky top-0 text-slate-500 uppercase z-10">
                        <tr>
                            <th class="px-3 py-2">å» å•†</th>
                            <th class="px-3 py-2 text-center border-l">P1 å ´æ¬¡</th>
                            <th class="px-3 py-2 text-right">P1 ç§Ÿé‡‘ (æŠ˜å¾Œ)</th>
                            <th class="px-3 py-2 text-center border-l">P2 å ´æ¬¡</th>
                            <th class="px-3 py-2 text-right">P2 ç§Ÿé‡‘ (æŠ˜å¾Œ)</th>
                            <th class="px-3 py-2 text-center border-l">æŠ˜æ‰£ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        <tr v-for="stat in analysisStats" :key="stat.name" class="hover:bg-slate-50">
                            <td class="px-3 py-2 font-bold text-slate-700">{{ stat.name }}</td>
                            <td class="px-3 py-2 text-center border-l bg-slate-50/50">{{ stat.p1Count }}</td>
                            <td class="px-3 py-2 text-right font-mono">
                                <div class="text-slate-800">${{ stat.p1Rent.total.toLocaleString() }}</div>
                                <div v-if="stat.p1Rent.discount < 1" class="text-[9px] text-slate-400 line-through">${{ stat.p1Rent.original.toLocaleString() }}</div>
                            </td>
                            <td class="px-3 py-2 text-center border-l bg-slate-50/50">{{ stat.p2Count }}</td>
                            <td class="px-3 py-2 text-right font-mono">
                                <div class="text-slate-800">${{ stat.p2Rent.total.toLocaleString() }}</div>
                                <div v-if="stat.p2Rent.discount < 1" class="text-[9px] text-slate-400 line-through">${{ stat.p2Rent.original.toLocaleString() }}</div>
                            </td>
                            <td class="px-3 py-2 text-center border-l">
                                <div class="flex gap-1 justify-center">
                                    <span v-if="stat.p1Rent.discount < 1" class="px-1 rounded text-[9px] text-white" :class="stat.p1Rent.discount===0.85?'bg-green-500':'bg-blue-400'">P1 {{stat.p1Rent.discount===0.85?'85':'90'}}æŠ˜</span>
                                    <span v-if="stat.p2Rent.discount < 1" class="px-1 rounded text-[9px] text-white" :class="stat.p2Rent.discount===0.85?'bg-green-500':'bg-blue-400'">P2 {{stat.p2Rent.discount===0.85?'85':'90'}}æŠ˜</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div v-if="analysisTab==='strategy'">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="border rounded p-3">
                            <h4 class="font-bold text-slate-700 mb-2 border-b pb-1">å‡ºå‹¤è¦å¾‹åˆ†æ</h4>
                            <div class="space-y-2">
                                <div v-for="s in strategyStats" :key="s.name" class="flex justify-between items-center text-xs">
                                    <span>{{ s.name }}</span>
                                    <div class="flex gap-2">
                                        <span v-if="s.topDay" class="bg-indigo-50 text-indigo-700 px-2 rounded">å¸¸é§: {{s.topDay}}</span>
                                        <span class="text-slate-400">{{ s.category || 'æœªåˆ†é¡' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="border rounded p-3">
                            <h4 class="font-bold text-slate-700 mb-2 border-b pb-1">æ¯æ—¥é¡åˆ¥ç›¸è¥¯ (è¿‘7æ—¥)</h4>
                            <p class="text-xs text-slate-500 mb-2">åˆ†ææ¯æ—¥ç«™é»çš„å» å•†é¡åˆ¥è±å¯Œåº¦</p>
                            <div class="text-xs space-y-2">
                                <div v-for="d in synergyData" :key="d.date" class="border-b pb-1">
                                    <div class="font-bold">{{d.date}}</div>
                                    <div class="flex gap-1 mt-1">
                                        <span v-for="cat in d.categories" class="px-1 bg-slate-100 rounded text-[9px] border">{{cat}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'vendor'" class="h-full bg-white rounded-lg shadow overflow-hidden flex flex-col">
            <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-slate-700">å» å•†è³‡æ–™åº«</h3>
                <div class="flex gap-2">
                    <button @click="autoGenerateVendors" class="text-xs bg-slate-200 hover:bg-slate-300 px-3 py-1 rounded">é‡æ–°æƒæ</button>
                    <button @click="addNewVendor" class="text-xs bg-emerald-600 text-white hover:bg-emerald-700 px-3 py-1 rounded"><i class="fa-solid fa-plus"></i> æ–°å¢</button>
                </div>
            </div>
            <div class="flex-grow overflow-auto p-4 custom-scrollbar">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div v-for="vendor in vendorList" :key="vendor.id" class="border rounded-lg p-3 shadow-sm bg-white relative group">
                        <div class="flex justify-between items-start mb-2">
                            <input v-model="vendor.displayName" class="font-bold text-lg text-slate-800 border-b border-transparent hover:border-slate-300 focus:border-indigo-500 outline-none w-full" placeholder="å» å•†é¡¯ç¤ºåç¨±">
                            <button @click="simulateVendorLogin(vendor)" class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-200" title="æ¨¡æ“¬ç™»å…¥å›å ±æ¥­ç¸¾"><i class="fa-solid fa-user-clock"></i> å›å ±æ¨¡å¼</button>
                        </div>
                        
                        <div class="mb-2">
                            <label class="text-[10px] text-slate-400 block">ä¸»ç‡Ÿé¡åˆ¥ (ç”¨æ–¼åˆ†æ)</label>
                            <select v-model="vendor.category" class="w-full text-xs border rounded p-1 bg-slate-50">
                                <option value="">æœªåˆ†é¡</option>
                                <option value="è¾²ç”¢">è¾²ç”¢ (è”¬èœ/æ°´æœ)</option>
                                <option value="çƒ˜ç„™">çƒ˜ç„™ (éºµåŒ…/è›‹ç³•)</option>
                                <option value="åŠ å·¥">åŠ å·¥å“ (é†¬æ–™/ä¹¾è²¨)</option>
                                <option value="é¤Šæ®–">ç•œç‰§é¤Šæ®– (è›‹/å¥¶/èœœ)</option>
                            </select>
                        </div>

                        <div class="bg-slate-50 rounded p-2 text-xs mb-2">
                            <div class="font-bold text-slate-500 mb-1">CSV åŸå§‹åç¨± (åˆä½µç”¨):</div>
                            <div class="flex flex-wrap gap-1">
                                <span v-for="(alias, aidx) in vendor.aliases" :key="aidx" class="bg-white border px-2 py-0.5 rounded flex items-center gap-1">
                                    {{ alias }}
                                    <button @click="removeAlias(vendor, alias)" class="text-red-400 hover:text-red-600">Ã—</button>
                                </span>
                                <button @click="addAlias(vendor)" class="bg-slate-200 px-2 py-0.5 rounded hover:bg-slate-300 text-slate-600">+</button>
                            </div>
                        </div>
                        <button @click="deleteVendor(vendor.id)" class="absolute bottom-3 right-3 text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'settings'" class="h-full bg-white rounded-lg shadow p-8">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">ç³»çµ±èˆ‡è³‡æ–™è¨­å®š</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="font-bold text-lg mb-4 border-b pb-2">è³‡æ–™éæ¿¾é è¨­</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2">é è¨­é¡¯ç¤ºæœˆä»½</label>
                        <select class="w-full border rounded p-2 bg-slate-50">
                            <option>ç•¶å‰æœˆä»½</option>
                            <option>é¡¯ç¤ºå…¨éƒ¨</option>
                        </select>
                        <p class="text-xs text-slate-500 mt-1">é€²å…¥ç³»çµ±æ™‚å°‡è‡ªå‹•æ‡‰ç”¨æ­¤éæ¿¾å™¨ã€‚</p>
                    </div>
                </div>
                
                <div>
                    <h3 class="font-bold text-lg mb-4 border-b pb-2">è³‡æ–™åº«ç¶­è­·</h3>
                    <button @click="showInput = true" class="bg-slate-200 text-slate-700 px-4 py-2 rounded hover:bg-slate-300 w-full mb-2 text-left">
                        <i class="fa-solid fa-file-csv"></i> é‡æ–°åŒ¯å…¥åŸå§‹ CSV
                    </button>
                    <button class="bg-red-50 text-red-600 px-4 py-2 rounded hover:bg-red-100 w-full text-left">
                        <i class="fa-solid fa-trash-can"></i> æ¸…é™¤æ‰€æœ‰å¿«å–è³‡æ–™
                    </button>
                </div>
            </div>
        </div>

    </main>

    <div v-if="showInput" class="fixed inset-0 bg-slate-900/90 z-[80] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl rounded-lg h-[80vh] flex flex-col p-4">
            <div class="flex justify-between mb-2">
                <h3 class="font-bold">åŸå§‹è³‡æ–™åŒ¯å…¥</h3>
                <button @click="showInput = false" class="text-slate-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <textarea v-model="csvInput" class="flex-grow p-2 font-mono text-xs border rounded mb-2" placeholder="Paste CSV here..."></textarea>
            <button @click="processCSV" class="bg-emerald-600 text-white px-4 py-2 rounded font-bold">é–‹å§‹è§£æ</button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

    // --- Mock Cloud Service ---
    const CloudService = {
        save: async (key, data) => new Promise(r => setTimeout(() => { localStorage.setItem('v96_'+key, JSON.stringify(data)); r(); }, 800)),
        load: async (key) => new Promise(r => { const d = localStorage.getItem('v96_'+key); r(d ? JSON.parse(d) : null); })
    };

    createApp({
        setup() {
            // State
            const currentView = ref('kanban');
            const showInput = ref(false);
            const showPKModal = ref(false);
            const isSaving = ref(false);
            const csvInput = ref('');
            const analysisTab = ref('rent');
            
            // Data
            const schedules = ref([]);
            const vendorList = ref([]);
            const pkList = ref([]); // Array of Vendor IDs

            // --- Business Logic ---

            const processCSV = async () => {
                if (!csvInput.value) return;
                const parsed = Papa.parse(csvInput.value, { header: false, skipEmptyLines: true });
                const rows = parsed.data;
                const newSchedules = [];
                const colMap = {};

                if (rows.length > 1) {
                    rows[0].forEach((c, i) => {
                        if (i === 0) return;
                        const m = c.match(/(\d{1,2})\/(\d{1,2})/);
                        if (m) colMap[i] = `${parseInt(m[1]) >= 11 ? 2025 : 2026}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}`;
                    });

                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row[0]) continue;
                        let drawer = row[0].includes('é›™é€£') ? 'é›™é€£' : row[0].includes('å£«æ—') ? 'å£«æ—' : 'çŸ³ç‰Œ';
                        
                        row.forEach((cell, idx) => {
                            if (idx === 0 || !colMap[idx] || !cell.trim()) return;
                            cell.split(/[,ï¼Œã€]/).forEach(rawName => {
                                rawName = rawName.trim();
                                if (rawName) {
                                    newSchedules.push({
                                        id: crypto.randomUUID(),
                                        date: colMap[idx],
                                        drawer,
                                        station: row[0],
                                        rawStaff: rawName,
                                        status: 'active',
                                        sales: 0,
                                        timeAdjustment: ''
                                    });
                                }
                            });
                        });
                    }
                    schedules.value = newSchedules;
                    autoGenerateVendors();
                    showInput.value = false;
                    await saveAll();
                    Swal.fire({ icon: 'success', title: 'åŒ¯å…¥æˆåŠŸ', text: `å…±è§£æ ${newSchedules.length} ç­†ç­è¡¨`, timer: 1500, showConfirmButton: false });
                }
            };

            const autoGenerateVendors = () => {
                const rawNames = [...new Set(schedules.value.map(s => s.rawStaff))];
                rawNames.forEach(raw => {
                    if (!vendorList.value.some(v => v.aliases.includes(raw))) {
                        vendorList.value.push({ id: crypto.randomUUID().substring(0,8), displayName: raw, aliases: [raw], category: '' });
                    }
                });
                // Link vendorId to schedules
                linkVendorsToSchedules();
            };

            const linkVendorsToSchedules = () => {
                schedules.value.forEach(s => {
                    const v = vendorList.value.find(ven => ven.aliases.includes(s.rawStaff));
                    if (v) s.vendorId = v.id;
                });
            };

            const saveAll = async () => {
                isSaving.value = true;
                await CloudService.save('schedules', schedules.value);
                await CloudService.save('vendors', vendorList.value);
                isSaving.value = false;
            };

            // --- Vendor Portal Simulation ---
            const simulateVendorLogin = async (vendor) => {
                // In a real app, this would route to a different page. Here we simulate the modal.
                // Filter shifts for this vendor only
                const myShifts = schedules.value.filter(s => s.vendorId === vendor.id && new Date(s.date) >= new Date());
                
                if(myShifts.length === 0) {
                    Swal.fire('ç„¡è¿‘æœŸç­è¡¨', 'æ‚¨ç›®å‰æ²’æœ‰æœªä¾†çš„æ’ç­è³‡æ–™ã€‚', 'info');
                    return;
                }

                // Pick the next shift
                openShiftDetail(myShifts[0], true); 
            };

            const openShiftDetail = async (shift, isVendorMode = false) => {
                const vendor = vendorList.value.find(v => v.id === shift.vendorId);
                const title = isVendorMode ? `ğŸ‘‹ æ­¡è¿, ${vendor.displayName}` : 'ç®¡ç†è€…ç·¨è¼¯';
                
                const { value: form } = await Swal.fire({
                    title: title,
                    html: `
                        <div class="text-left text-sm bg-slate-50 p-3 rounded mb-3">
                            <p><strong>æ—¥æœŸ:</strong> ${shift.date} (${new Date(shift.date).toLocaleDateString('zh-TW', {weekday:'short'})})</p>
                            <p><strong>ç«™é»:</strong> ${shift.station}</p>
                        </div>
                        <div class="text-left space-y-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-500">å‡ºå¸­ç‹€æ…‹</label>
                                <select id="swal-status" class="w-full border p-2 rounded">
                                    <option value="active" ${shift.status === 'active' ? 'selected' : ''}>æ­£å¸¸å‡ºå¸­</option>
                                    <option value="leave" ${shift.status === 'leave' ? 'selected' : ''}>è«‹å‡ / å–æ¶ˆ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500">ç•¶æ—¥æ¥­ç¸¾å›å ± ($)</label>
                                <input id="swal-sales" type="number" class="w-full border p-2 rounded" value="${shift.sales}">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500">æ™‚é–“èª¿æ•´ / å‚™è¨»</label>
                                <input id="swal-time" type="text" class="w-full border p-2 rounded" placeholder="ä¾‹å¦‚: æ™šåˆ°1å°æ™‚, æ—©é€€..." value="${shift.timeAdjustment || ''}">
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'æäº¤å›å ±',
                    confirmButtonColor: '#059669',
                    preConfirm: () => ({
                        status: document.getElementById('swal-status').value,
                        sales: parseInt(document.getElementById('swal-sales').value) || 0,
                        time: document.getElementById('swal-time').value
                    })
                });

                if (form) {
                    shift.status = form.status;
                    shift.sales = form.sales;
                    shift.timeAdjustment = form.time;
                    await saveAll();
                    Swal.fire({ icon: 'success', title: 'å›å ±å·²å„²å­˜', timer: 1000, showConfirmButton: false });
                }
            };

            // --- Analysis Logic ---
            const financialSummary = computed(() => {
                let p1T = 0, p2T = 0;
                analysisStats.value.forEach(s => {
                    p1T += s.p1Rent.total;
                    p2T += s.p2Rent.total;
                });
                const growth = p1T > 0 ? Math.round(((p2T - p1T) / p1T) * 100) : 0;
                return { p1Total: p1T, p2Total: p2T, growth };
            });

            const analysisStats = computed(() => {
                return vendorList.value.map(v => {
                    const shifts = schedules.value.filter(s => s.vendorId === v.id && s.status !== 'leave');
                    
                    // P1: Nov, Dec, Jan (Months 11, 12, 1)
                    const p1Shifts = shifts.filter(s => {
                        const m = parseInt(s.date.split('-')[1]);
                        return [11, 12, 1].includes(m);
                    });
                    
                    // P2: Feb, Mar, Apr (Months 2, 3, 4)
                    const p2Shifts = shifts.filter(s => {
                        const m = parseInt(s.date.split('-')[1]);
                        return [2, 3, 4].includes(m);
                    });

                    const calc = (count) => {
                        const base = count * 800;
                        let discount = 1;
                        if (count >= 20) discount = 0.85;
                        else if (count >= 10) discount = 0.90;
                        return { total: Math.round(base * discount), original: base, discount };
                    };

                    return {
                        name: v.displayName,
                        p1Count: p1Shifts.length,
                        p2Count: p2Shifts.length,
                        p1Rent: calc(p1Shifts.length),
                        p2Rent: calc(p2Shifts.length)
                    };
                }).sort((a,b) => b.p2Count - a.p2Count);
            });

            const strategyStats = computed(() => {
                return vendorList.value.map(v => {
                    const shifts = schedules.value.filter(s => s.vendorId === v.id);
                    // Find most frequent weekday
                    const days = {};
                    shifts.forEach(s => {
                        const wd = new Date(s.date).toLocaleDateString('zh-TW', {weekday:'short'});
                        days[wd] = (days[wd] || 0) + 1;
                    });
                    let topDay = '';
                    let max = 0;
                    for (const [d, c] of Object.entries(days)) {
                        if(c > max && c > 2) { max = c; topDay = d; } // Threshold > 2
                    }
                    return { name: v.displayName, category: v.category, topDay };
                }).filter(s => s.category || s.topDay);
            });

            const synergyData = computed(() => {
                // Mockup: Look at last 7 days from dataset end
                const dates = [...new Set(schedules.value.map(s => s.date))].sort().slice(-7);
                return dates.map(date => {
                    const dayShifts = schedules.value.filter(s => s.date === date);
                    const cats = new Set();
                    dayShifts.forEach(s => {
                        const v = vendorList.value.find(vn => vn.id === s.vendorId);
                        if(v && v.category) cats.add(v.category);
                    });
                    return { date, categories: [...cats] };
                });
            });

            // --- Helpers ---
            const getPKColorClass = (vid, isBg = false) => {
                if(!vid) return '';
                const idx = pkList.value.indexOf(vid);
                if (idx === -1) return '';
                return `pk-${idx}`;
            };
            const navClass = (v) => currentView.value === v ? 'bg-indigo-600 text-white shadow font-bold' : 'text-slate-400 hover:text-white';
            
            // Reused Kanban/Matrix Logic from previous
            const calendarWeeks = computed(() => {
                const dates = [...new Set(schedules.value.map(s => s.date))].sort();
                if (dates.length === 0) return [];
                const start = new Date(dates[0]);
                start.setDate(start.getDate() - (start.getDay() === 0 ? 6 : start.getDay() - 1));
                const end = new Date(dates[dates.length-1]);
                const weeks = [];
                let curr = new Date(start);
                let lastMonth = -1;
                while (curr <= end) {
                    const days = [];
                    let monthLabel = '';
                    let isMonthStart = false;
                    for(let i=0; i<5; i++) {
                        const dStr = curr.toISOString().slice(0,10);
                        const m = curr.getMonth()+1;
                        if(m !== lastMonth && i===0) { monthLabel=`${curr.getFullYear()}/${m}`; isMonthStart=true; lastMonth=m; }
                        days.push({ dateStr: dStr, dayNum: curr.getDate(), weekday: ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][curr.getDay()], isToday: new Date().toISOString().slice(0,10) === dStr });
                        curr.setDate(curr.getDate()+1);
                    }
                    weeks.push({id:weeks.length, monthLabel, isMonthStart, days});
                    curr.setDate(curr.getDate()+2);
                }
                return weeks;
            });
            const matrixHeaders = computed(() => [...new Set(schedules.value.map(s => s.date))].sort().map(d => ({ simpleDate: d.substring(5).replace('-','/'), dayName: `(${new Date(d).toLocaleDateString('zh-TW',{weekday:'short'})})`, date: d })));
            const matrixGroups = computed(() => {
                const grps = [];
                ['é›™é€£','å£«æ—','çŸ³ç‰Œ'].forEach(k => {
                    const st = [...new Set(schedules.value.filter(s => s.drawer===k).map(s => s.station))];
                    const rows = st.map(station => ({
                        station,
                        isShilin: k==='å£«æ—',
                        cells: matrixHeaders.value.map(h => {
                            const match = schedules.value.find(s => s.date === h.date && s.station === station);
                            return match ? { name: getDisplayStaff(match), status: match.status, vendorId: match.vendorId, shift: match } : null;
                        })
                    }));
                    if(rows.length) grps.push({name: k, rows, badgeClass: k==='å£«æ—'?'bg-emerald-500':k==='é›™é€£'?'bg-blue-500':'bg-amber-500'});
                });
                return grps;
            });
            const drawers = [{key:'é›™é€£',name:'é›™é€£',colorClass:'bg-blue-500'},{key:'å£«æ—',name:'å£«æ—',colorClass:'bg-emerald-500'},{key:'çŸ³ç‰Œ',name:'çŸ³ç‰Œ',colorClass:'bg-amber-500'}];
            const getDisplayStaff = (s) => { const v = vendorList.value.find(vn => vn.id === s.vendorId); return v ? v.displayName : s.rawStaff; };
            const getShifts = (d,k) => schedules.value.filter(s => s.date===d && s.drawer===k);
            const getDrawerShiftCount = (k) => schedules.value.filter(s => s.drawer===k).length;
            const truncateName = (n) => n.length > 4 ? n.substring(0,3)+'..' : n;
            const handleSyncScroll = (e) => document.querySelectorAll('.sync-scroll-target').forEach(el => el.scrollTop = e.target.scrollTop);
            const addNewVendor = () => vendorList.value.unshift({id:crypto.randomUUID().substring(0,8), displayName:'æ–°å» å•†', aliases:[], category:''});
            const deleteVendor = (id) => { if(confirm('åˆªé™¤?')) vendorList.value = vendorList.value.filter(v=>v.id!==id); };
            const addAlias = async (v) => { const {value} = await Swal.fire({input:'text'}); if(value) v.aliases.push(value); };
            const removeAlias = (v,a) => v.aliases = v.aliases.filter(x=>x!==a);

            onMounted(async () => {
                const s = await CloudService.load('schedules');
                const v = await CloudService.load('vendors');
                if(s) schedules.value = s;
                if(v) vendorList.value = v;
                linkVendorsToSchedules();
            });

            return {
                currentView, showInput, showPKModal, isSaving, csvInput, analysisTab,
                navClass, processCSV, pkList, vendorList, pkList,
                drawers, calendarWeeks, getShifts, getDrawerShiftCount, truncateName, getDisplayStaff, getPKColorClass,
                matrixHeaders, matrixGroups,
                analysisStats, financialSummary, strategyStats, synergyData,
                addNewVendor, deleteVendor, addAlias, removeAlias, simulateVendorLogin,
                openShiftDetail, handleSyncScroll
            };
        }
    }).mount('#app');
</script>
</body>
</html>