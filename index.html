<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»é»ç¶ æ’ç­æˆ°ç•¥ç³»çµ± v9.9 (Admin Edition)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; color: #1f2937; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Bento UI Utilities */
        .bento-card { background: white; border-radius: 1rem; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; }
        .bento-header { padding: 1rem; border-bottom: 1px solid #f3f4f6; font-weight: 700; color: #374151; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }

        /* Scrollbars */
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        
        /* Matrix View (Fixed Scrolling) */
        .matrix-table { border-collapse: separate; border-spacing: 0; font-size: 0.75rem; }
        .matrix-table th, .matrix-table td { border-right: 1px solid #f3f4f6; border-bottom: 1px solid #f3f4f6; padding: 6px 8px; white-space: nowrap; text-align: center; height: 36px; }
        .matrix-table thead th { background-color: #f9fafb; position: sticky; top: 0; z-index: 20; font-weight: 700; color: #4b5563; border-bottom: 2px solid #e5e7eb; }
        .matrix-table td:first-child { position: sticky; left: 0; background-color: #fff; z-index: 30; font-weight: 700; text-align: left; border-right: 2px solid #9ca3af; color: #111827; }
        .matrix-table th:first-child { position: sticky; left: 0; top: 0; z-index: 40; background-color: #f3f4f6; border-right: 2px solid #9ca3af; border-bottom: 2px solid #e5e7eb; }
        
        /* Visuals */
        .shilin-bg { background-color: #ecfdf5 !important; }
        .station-divider { border-top: 2px solid #4b5563 !important; }

        /* Kanban */
        .kanban-col { flex: 1; min-width: 300px; background: #f9fafb; border-radius: 1rem; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #e5e7eb; }
        .shift-card { font-size: 0.75rem; padding: 6px 10px; margin-bottom: 6px; background: white; border-radius: 0.5rem; border-left: 4px solid #cbd5e1; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s; position: relative; }
        .shift-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .shift-leave { opacity: 0.6; text-decoration: line-through; background-color: #fef2f2; border-left-color: #ef4444; }
        .shift-has-sales { border-right: 4px solid #f59e0b; }

        /* PK Colors */
        .pk-0 { background-color: #fef2f2 !important; color: #b91c1c; border-left-color: #ef4444 !important; } 
        .pk-1 { background-color: #fffbeb !important; color: #92400e; border-left-color: #f59e0b !important; } 
        .pk-2 { background-color: #f0fdf4 !important; color: #166534; border-left-color: #22c55e !important; } 
        .pk-3 { background-color: #eff6ff !important; color: #1e40af; border-left-color: #3b82f6 !important; } 
        .pk-4 { background-color: #faf5ff !important; color: #6b21a8; border-left-color: #a855f7 !important; } 
        .pk-5 { background-color: #fdf2f8 !important; color: #9d174d; border-left-color: #ec4899 !important; } 
        .pk-6 { background-color: #ecfeff !important; color: #0e7490; border-left-color: #06b6d4 !important; } 
        .pk-7 { background-color: #f7fee7 !important; color: #3f6212; border-left-color: #84cc16 !important; } 

        /* Mobile Nav Transition */
        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
        .slide-enter-from, .slide-leave-to { transform: translateX(100%); }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak class="h-screen flex flex-col">

    <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 lg:px-6 shadow-sm z-50 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-gradient-to-br from-indigo-600 to-purple-700 rounded-lg flex items-center justify-center font-bold text-white shadow-md">
                v9.9
            </div>
            <div>
                <h1 class="font-bold text-lg text-gray-800 leading-tight">é»é»ç¶ æ’ç­</h1>
                <div class="text-[10px] text-gray-400 font-medium">Admin Edition</div>
            </div>
        </div>

        <div class="hidden md:flex items-center gap-1 bg-gray-100 p-1 rounded-xl">
            <button v-for="item in navItems" :key="item.key" @click="currentView=item.key" 
                :class="currentView===item.key ? 'bg-white text-indigo-600 shadow-sm font-bold' : 'text-gray-500 hover:text-gray-700'"
                class="px-4 py-1.5 text-xs rounded-lg transition-all">
                <i :class="item.icon" class="mr-1"></i> {{ item.label }}
            </button>
        </div>

        <div class="flex items-center gap-3">
            <div class="hidden md:flex items-center gap-2 text-xs px-3 py-1 bg-gray-50 rounded-full border border-gray-100">
                <div class="w-2 h-2 rounded-full" :class="isSaving ? 'bg-amber-400 animate-pulse' : 'bg-emerald-400'"></div>
                <span class="text-gray-500">{{ isSaving ? 'åŒæ­¥ä¸­...' : 'å·²åŒæ­¥' }}</span>
            </div>

            <button @click="openPerformanceModal" class="hidden md:flex bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-sm transition items-center gap-1">
                <i class="fa-solid fa-file-invoice-dollar"></i> æ¥­ç¸¾å›å ±
            </button>
            
            <button @click="showPKModal = true" class="relative bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-sm transition items-center gap-1 hidden md:flex">
                <i class="fa-solid fa-people-arrows"></i> PK
                <span v-if="pkList.length > 0" class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center">{{pkList.length}}</span>
            </button>

            <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden text-gray-600 p-2 rounded-lg hover:bg-gray-100">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
        </div>
    </header>

    <transition name="slide">
        <div v-if="mobileMenuOpen" class="fixed inset-y-0 right-0 w-64 bg-white shadow-2xl z-[60] md:hidden flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <span class="font-bold text-gray-800">åŠŸèƒ½é¸å–®</span>
                <button @click="mobileMenuOpen = false" class="text-gray-400"><i class="fa-solid fa-times text-lg"></i></button>
            </div>
            <div class="p-2 flex-grow overflow-y-auto">
                <button v-for="item in navItems" :key="item.key" @click="currentView=item.key; mobileMenuOpen=false" 
                    class="w-full text-left px-4 py-3 text-sm rounded-lg mb-1"
                    :class="currentView===item.key ? 'bg-indigo-50 text-indigo-600 font-bold' : 'text-gray-600 hover:bg-gray-50'">
                    <i :class="item.icon" class="mr-2 w-5"></i> {{ item.label }}
                </button>
                <hr class="my-2 border-gray-100">
                <button @click="openPerformanceModal; mobileMenuOpen=false" class="w-full text-left px-4 py-3 text-sm rounded-lg text-emerald-600 font-bold hover:bg-emerald-50">
                    <i class="fa-solid fa-file-invoice-dollar mr-2 w-5"></i> æ¥­ç¸¾å›å ±ä¸­å¿ƒ
                </button>
                <button @click="showPKModal=true; mobileMenuOpen=false" class="w-full text-left px-4 py-3 text-sm rounded-lg text-indigo-600 font-bold hover:bg-indigo-50">
                    <i class="fa-solid fa-people-arrows mr-2 w-5"></i> PK æˆ°æƒ…å®¤
                </button>
                <button @click="showInput=true; mobileMenuOpen=false" class="w-full text-left px-4 py-3 text-sm rounded-lg text-gray-500 hover:bg-gray-50">
                    <i class="fa-solid fa-file-import mr-2 w-5"></i> åŒ¯å…¥ CSV
                </button>
            </div>
        </div>
    </transition>

    <main class="flex-grow p-3 md:p-6 overflow-hidden relative">

        <div v-if="currentView === 'kanban'" class="h-full flex gap-3 overflow-x-auto pb-2">
            <div v-for="drawer in drawers" :key="drawer.key" class="kanban-col shadow-sm flex-shrink-0" style="width: 320px;">
                <div class="p-3 border-b bg-white flex justify-between items-center sticky top-0 z-10">
                    <div class="flex items-center gap-2"><div class="w-1.5 h-6 rounded-full" :class="drawer.colorClass"></div><span class="font-bold text-gray-700">{{ drawer.name }}å€</span></div>
                    <div class="text-[10px] text-gray-400 bg-gray-50 border rounded px-1.5 py-0.5">{{ getDrawerShiftCount(drawer.key) }}å ´</div>
                </div>
                <div class="overflow-y-auto custom-scroll flex-grow p-2 sync-scroll-target" @scroll="handleSyncScroll">
                    <div v-for="week in calendarWeeks" :key="week.id" class="mb-3">
                        <div v-if="week.isMonthStart" class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-2 pl-1">{{ week.monthLabel }}</div>
                        <div class="grid grid-cols-5 gap-1.5">
                            <div v-for="day in week.days" :key="day.dateStr" class="min-h-[80px] bg-white border border-gray-200 rounded-lg p-1.5 flex flex-col relative group hover:border-indigo-300 transition-colors">
                                <div class="text-[10px] text-gray-400 mb-1 flex justify-between border-b border-gray-100 pb-1">
                                    <span :class="{'text-indigo-600 font-bold bg-indigo-50 px-1 rounded': day.isToday}">{{ day.dayNum }}</span>
                                    <span>{{ day.weekday }}</span>
                                </div>
                                <div v-for="shift in getShifts(day.dateStr, drawer.key)" :key="shift.id" 
                                     class="shift-card" 
                                     :class="[getPKColorClass(shift.vendorId), shift.status === 'leave' ? 'shift-leave' : '', shift.sales > 0 ? 'shift-has-sales' : '']" 
                                     @click="openShiftDetail(shift)">
                                    <div class="font-bold truncate leading-tight">{{ truncateName(getDisplayStaff(shift)) }}</div>
                                    <div v-if="shift.sales > 0" class="text-[9px] text-amber-600 font-mono mt-0.5">${{shift.sales.toLocaleString()}}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="h-10"></div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'matrix'" class="bento-card h-full">
            <div class="bento-header bg-gray-50">
                <span>ç¸½è¡¨æ’ç¨‹</span>
                <span class="text-xs text-gray-400">Shift + æ»¾è¼ªå¯æ©«å‘æ²å‹•</span>
            </div>
            <div class="overflow-auto custom-scroll flex-grow relative bg-white w-full">
                <table class="matrix-table min-w-max w-full">
                    <thead>
                        <tr>
                            <th class="w-32 bg-gray-50 shadow-sm">ç«™å \ æ—¥æœŸ</th>
                            <th v-for="header in matrixHeaders" :key="header.date" class="min-w-[40px]">
                                <div class="font-bold text-gray-600">{{ header.simpleDate }}</div>
                                <div class="text-[9px] font-normal text-gray-400">{{ header.dayName }}</div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <template v-for="(group, gIndex) in matrixGroups" :key="group.name">
                            <tr v-for="(row, rIndex) in group.rows" :key="row.station" 
                                :class="[gIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50', rIndex === 0 && gIndex !== 0 ? 'station-divider' : '', row.isShilin ? 'shilin-bg' : '']">
                                <td class="shadow-sm">
                                    <div class="flex items-center justify-between">
                                        <span>{{ row.station }}</span>
                                        <span v-if="rIndex === 0" class="text-[9px] px-1.5 rounded-full text-white font-bold" :class="group.badgeClass">{{ group.name }}</span>
                                    </div>
                                </td>
                                <td v-for="(cell, i) in row.cells" :key="i" :class="getPKColorClass(cell?.vendorId)" @click="cell?.shift ? openShiftDetail(cell.shift) : null" class="cursor-pointer hover:bg-gray-100 transition-colors">
                                    <span :class="{'line-through text-gray-300': cell?.status === 'leave'}">{{ cell?.name }}</span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <div v-if="currentView === 'analysis'" class="h-full flex flex-col gap-4 overflow-hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 shrink-0">
                <div class="bento-card p-4 bg-slate-800 text-white flex flex-col justify-between">
                    <div class="text-xs text-slate-400 mb-1">P1 (11-1æœˆ) é ä¼°ç§Ÿé‡‘æˆæœ¬</div>
                    <div class="text-2xl font-bold font-mono text-emerald-400">${{ financialSummary.p1Total.toLocaleString() }}</div>
                </div>
                <div class="bento-card p-4 bg-slate-800 text-white flex flex-col justify-between">
                    <div class="text-xs text-slate-400 mb-1">P2 (2-4æœˆ) é ä¼°ç§Ÿé‡‘æˆæœ¬</div>
                    <div class="text-2xl font-bold font-mono text-emerald-400">${{ financialSummary.p2Total.toLocaleString() }}</div>
                </div>
                <div class="bento-card p-4 bg-slate-700 text-white flex items-center justify-between">
                    <div>
                        <div class="text-xs text-slate-400 mb-1">æˆæœ¬æˆé•·ç‡</div>
                        <div class="text-3xl font-bold" :class="financialSummary.growth >= 0 ? 'text-green-400' : 'text-red-400'">
                            {{ financialSummary.growth > 0 ? '+' : ''}}{{ financialSummary.growth }}%
                        </div>
                    </div>
                    <div class="text-right text-[10px] text-slate-400 leading-tight">
                        P1 vs P2<br>ç§Ÿé‡‘è¦å‰‡:<br>20å ´(85æŠ˜)<br>10å ´(9æŠ˜)
                    </div>
                </div>
            </div>

            <div class="flex-grow flex flex-col md:flex-row gap-4 overflow-hidden">
                <div class="flex-grow bento-card flex flex-col overflow-hidden">
                    <div class="bento-header bg-gray-50">
                        <span>å» å•†å‡ºå¸­èˆ‡ç§Ÿé‡‘åˆ†æ</span>
                        <div class="text-xs text-gray-400 font-normal">ä¾å ±åç†±åº¦æ’åº</div>
                    </div>
                    <div class="overflow-auto custom-scroll flex-grow p-0">
                        <table class="w-full text-xs text-left border-collapse">
                            <thead class="bg-gray-100 sticky top-0 text-gray-500 uppercase z-10 font-bold">
                                <tr>
                                    <th class="px-3 py-2">å» å•† (é¡åˆ¥)</th>
                                    <th class="px-3 py-2 text-center border-l">P1 å ´æ¬¡/ä½”æ¯”</th>
                                    <th class="px-3 py-2 text-right">P1 ç§Ÿé‡‘</th>
                                    <th class="px-3 py-2 text-center border-l">P2 å ´æ¬¡/ä½”æ¯”</th>
                                    <th class="px-3 py-2 text-right">P2 ç§Ÿé‡‘</th>
                                    <th class="px-3 py-2 text-center border-l">æˆé•·</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr v-for="stat in analysisStats" :key="stat.name" class="hover:bg-gray-50">
                                    <td class="px-3 py-2">
                                        <div class="font-bold text-gray-700">{{ stat.name }}</div>
                                        <div class="text-[9px] text-gray-400">{{ stat.category || 'æœªåˆ†é¡' }}</div>
                                    </td>
                                    <td class="px-3 py-2 border-l">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="font-bold">{{ stat.p1Count }}å ´</span>
                                            <span v-if="stat.p1Rent.discount < 1" class="text-[9px] px-1 rounded text-white" :class="stat.p1Rent.discount===0.85?'bg-green-500':'bg-blue-400'">{{stat.p1Rent.discount===0.85?'85':'90'}}æŠ˜</span>
                                        </div>
                                        <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden flex">
                                            <div class="bg-blue-400 h-full" :style="{width: stat.p1Dist.sl+'%'}"></div>
                                            <div class="bg-emerald-400 h-full" :style="{width: stat.p1Dist.slin+'%'}"></div>
                                            <div class="bg-amber-400 h-full" :style="{width: stat.p1Dist.sp+'%'}"></div>
                                        </div>
                                    </td>
                                    <td class="px-3 py-2 text-right font-mono text-gray-600">
                                        ${{ stat.p1Rent.total.toLocaleString() }}
                                    </td>
                                    <td class="px-3 py-2 border-l">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="font-bold">{{ stat.p2Count }}å ´</span>
                                            <span v-if="stat.p2Rent.discount < 1" class="text-[9px] px-1 rounded text-white" :class="stat.p2Rent.discount===0.85?'bg-green-500':'bg-blue-400'">{{stat.p2Rent.discount===0.85?'85':'90'}}æŠ˜</span>
                                        </div>
                                        <div class="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden flex">
                                            <div class="bg-blue-400 h-full" :style="{width: stat.p2Dist.sl+'%'}"></div>
                                            <div class="bg-emerald-400 h-full" :style="{width: stat.p2Dist.slin+'%'}"></div>
                                            <div class="bg-amber-400 h-full" :style="{width: stat.p2Dist.sp+'%'}"></div>
                                        </div>
                                    </td>
                                    <td class="px-3 py-2 text-right font-mono text-gray-600">
                                        ${{ stat.p2Rent.total.toLocaleString() }}
                                    </td>
                                    <td class="px-3 py-2 text-center border-l">
                                        <span :class="stat.growth >= 0 ? 'text-green-600' : 'text-red-500'">{{ stat.growth }}%</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="w-full md:w-80 flex flex-col gap-4 shrink-0">
                    <div class="bento-card p-3">
                        <h4 class="font-bold text-gray-700 text-sm mb-3 border-b pb-2">å„ç«™é»ç†±é–€å» å•† Top 3</h4>
                        <div v-for="st in platformInsights.stations" :key="st.name" class="mb-3">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="w-2 h-2 rounded-full" :class="st.color"></div>
                                <span class="text-xs font-bold">{{ st.name }}å€</span>
                            </div>
                            <div class="space-y-1">
                                <div v-for="(v, i) in st.top3" :key="i" class="flex justify-between text-[10px] text-gray-600 bg-gray-50 px-2 py-1 rounded">
                                    <span>{{ i+1 }}. {{ v.name }}</span>
                                    <span class="font-mono">{{ v.count }}å ´</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bento-card p-3 flex-grow">
                        <h4 class="font-bold text-gray-700 text-sm mb-3 border-b pb-2">é¡åˆ¥å¹³è¡¡ (Category)</h4>
                        <div class="space-y-3">
                            <div v-for="cat in platformInsights.categories" :key="cat.name" class="text-xs">
                                <div class="flex justify-between mb-1">
                                    <span>{{ cat.name }}</span>
                                    <span class="text-gray-400">{{ cat.count }}å ´ ({{ cat.pct }}%)</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-2">
                                    <div class="bg-indigo-500 h-2 rounded-full" :style="{width: cat.pct + '%'}"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'vendor'" class="bento-card h-full p-4 flex flex-col">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-2">
                <div class="flex items-center gap-2">
                    <h3 class="font-bold text-gray-800 text-lg">å» å•†è³‡æ–™åº«</h3>
                    <span class="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-500">{{ vendorList.length }} å®¶</span>
                </div>
                
                <div class="flex gap-2 w-full md:w-auto">
                    <div class="relative flex-grow md:flex-grow-0">
                        <i class="fa-solid fa-search absolute left-2 top-2 text-gray-400 text-xs"></i>
                        <input v-model="vendorSearch" type="text" placeholder="æœå°‹å» å•†..." class="pl-7 pr-3 py-1.5 text-xs border rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none w-full md:w-48 transition-all">
                    </div>
                    <button @click="addNewVendor" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-emerald-500 transition shadow-sm whitespace-nowrap">
                        <i class="fa-solid fa-plus mr-1"></i> æ–°å¢
                    </button>
                </div>
            </div>
            
            <div class="overflow-auto custom-scroll flex-grow">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-2">
                    <div v-for="v in filteredVendors" :key="v.id" class="border rounded-xl p-3 bg-white hover:shadow-md transition-shadow relative group">
                        <div class="flex justify-between items-start mb-2">
                            <input v-model="v.displayName" class="font-bold text-gray-800 border-b border-transparent hover:border-gray-300 focus:border-indigo-500 outline-none w-full mr-2 text-sm transition-colors">
                            <button @click="simulateVendorLogin(v)" class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-100 transition whitespace-nowrap" title="æ¨¡æ“¬ç™»å…¥å›å ±ä»‹é¢">
                                <i class="fa-solid fa-user-clock mr-1"></i>å›å ±æ¨¡å¼
                            </button>
                        </div>
                        
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] text-gray-400">ç¸½å ´æ¬¡: {{ getShiftCount(v.id) }}</span>
                            <select v-model="v.category" class="text-[10px] border rounded p-1 bg-gray-50 outline-none w-1/2">
                                <option value="">é¸æ“‡é¡åˆ¥...</option>
                                <option value="è¾²ç”¢">ğŸ¥¦ è¾²ç”¢è”¬æœ</option>
                                <option value="çƒ˜ç„™">ğŸ çƒ˜ç„™ç”œé»</option>
                                <option value="åŠ å·¥">ğŸ¥« åŠ å·¥é£Ÿå“</option>
                                <option value="é¤Šæ®–">ğŸ¥š ç•œç‰§é¤Šæ®–</option>
                                <option value="æ–‡å‰µ">ğŸ¨ æ–‡å‰µæ‰‹ä½œ</option>
                            </select>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-2 min-h-[40px]">
                            <div class="text-[9px] text-gray-400 mb-1">CSV åŸå§‹åç¨± (åˆ¥å)</div>
                            <div class="flex flex-wrap gap-1">
                                 <span v-for="a in v.aliases" :key="a" class="text-[10px] bg-white border px-1.5 rounded flex items-center shadow-sm">
                                    {{a}} <button @click="removeAlias(v,a)" class="ml-1 text-gray-300 hover:text-red-500">Ã—</button>
                                 </span>
                                 <button @click="addAlias(v)" class="text-[10px] bg-gray-200 hover:bg-gray-300 text-gray-600 px-1.5 rounded transition">+</button>
                            </div>
                        </div>
                        
                        <button @click="deleteVendor(v.id)" class="absolute bottom-2 right-2 text-gray-200 hover:text-red-500 transition p-1" title="åˆªé™¤å» å•†">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </div>
                <div v-if="filteredVendors.length === 0" class="text-center text-gray-400 py-10">
                    æ‰¾ä¸åˆ°ç¬¦åˆçš„å» å•†
                </div>
            </div>
        </div>
        
        <div v-if="currentView === 'settings'" class="bento-card h-full p-6 overflow-auto custom-scroll">
            <h2 class="text-xl font-bold mb-4 text-gray-800">ç³»çµ±èˆ‡è³‡æ–™è¨­å®š</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="border border-indigo-100 bg-indigo-50/50 p-5 rounded-xl">
                    <h3 class="font-bold text-indigo-800 mb-3 flex items-center">
                        <i class="fa-solid fa-calendar-plus mr-2"></i>æ‰‹å‹•è£œç™»æ’ç­ (æ–°å¢å¡ç‰‡)
                    </h3>
                    <div class="space-y-3 bg-white p-4 rounded-lg shadow-sm border border-indigo-100">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label>
                                <input type="date" v-model="manualShift.date" class="w-full text-sm border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">å€åŸŸ</label>
                                <select v-model="manualShift.drawer" class="w-full text-sm border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <option v-for="d in drawers" :key="d.key" :value="d.key">{{ d.name }}</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">ç«™é»åç¨± (å¦‚: é›™é€£1è™Ÿ)</label>
                            <input type="text" v-model="manualShift.station" placeholder="è¼¸å…¥ç«™é»åç¨±" class="w-full text-sm border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">å» å•†</label>
                            <select v-model="manualShift.vendorId" class="w-full text-sm border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="">è«‹é¸æ“‡å» å•†...</option>
                                <option v-for="v in sortedVendors" :key="v.id" :value="v.id">{{ v.displayName }}</option>
                            </select>
                        </div>
                        <button @click="addManualShift" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold shadow hover:bg-indigo-700 transition">
                            <i class="fa-solid fa-plus-circle mr-1"></i> åŠ å…¥æ’ç­
                        </button>
                    </div>
                </div>

                <div class="flex flex-col gap-4">
                    <div class="border p-4 rounded-xl">
                        <h3 class="font-bold text-gray-700 mb-2"><i class="fa-solid fa-file-import mr-2"></i>è³‡æ–™åŒ¯å…¥</h3>
                        <p class="text-xs text-gray-400 mb-3">å¾ Excel/CSV è¤‡è£½è²¼ä¸ŠåŸå§‹æ’ç­è³‡æ–™ä»¥è¦†è“‹ç¾æœ‰è³‡æ–™ã€‚</p>
                        <button @click="showInput=true" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-200 transition w-full">
                            é‡æ–°åŒ¯å…¥åŸå§‹ CSV
                        </button>
                    </div>

                    <div class="border border-emerald-100 bg-emerald-50/30 p-4 rounded-xl flex-grow flex flex-col">
                        <h3 class="font-bold text-emerald-800 mb-2"><i class="fa-solid fa-file-export mr-2"></i>åŒ¯å‡ºç³»çµ±è³‡æ–™</h3>
                        <p class="text-xs text-gray-400 mb-3">å°‡ç›®å‰æ‰€æœ‰ä¿®æ”¹å¾Œçš„æ’ç­ã€æ¥­ç¸¾èˆ‡ç‹€æ…‹åŒ¯å‡ºç‚º CSVã€‚</p>
                        
                        <textarea readonly v-model="exportText" class="w-full flex-grow p-2 text-[10px] font-mono border rounded mb-2 bg-white h-24 focus:outline-none" placeholder="é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç”Ÿæˆ CSV..."></textarea>
                        
                        <div class="flex gap-2">
                            <button @click="generateExport" class="flex-1 bg-emerald-600 text-white py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 transition">
                                ç”Ÿæˆ CSV
                            </button>
                            <button v-if="exportText" @click="copyExport" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 transition" title="è¤‡è£½åˆ°å‰ªè²¼ç°¿">
                                <i class="fa-regular fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <transition name="fade">
        <div v-if="salesReportModal.open" class="fixed inset-0 bg-slate-900/90 z-[70] flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-4xl h-[90vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                <div class="p-4 bg-slate-50 border-b flex justify-between items-center shrink-0">
                    <div>
                        <h3 class="font-bold text-lg text-slate-800"><i class="fa-solid fa-file-invoice-dollar text-emerald-600 mr-2"></i>æ¥­ç¸¾å›å ±ä¸­å¿ƒ</h3>
                        <p class="text-xs text-slate-500">è«‹é¸æ“‡å» å•†ä¸¦å¡«å¯«ç•¶æ—¥æ¥­ç¸¾</p>
                    </div>
                    <button @click="salesReportModal.open=false" class="text-slate-400 hover:text-slate-600 bg-white p-2 rounded-full shadow-sm"><i class="fa-solid fa-times"></i></button>
                </div>

                <div class="p-4 border-b bg-white flex flex-col md:flex-row gap-4 items-center shrink-0">
                    <select v-model="salesReportModal.vendorId" class="w-full md:w-1/3 p-2 border rounded-lg bg-slate-50 font-bold text-slate-700 outline-none focus:ring-2 focus:ring-emerald-500">
                        <option v-for="v in sortedVendors" :key="v.id" :value="v.id">{{ v.displayName }} ({{getShiftCount(v.id)}}å ´)</option>
                    </select>
                    
                    <div class="flex-grow grid grid-cols-3 gap-2 w-full">
                        <div class="bg-emerald-50 p-2 rounded-lg text-center border border-emerald-100">
                            <div class="text-[10px] text-emerald-600">å·²å›å ±ç¸½æ¥­ç¸¾</div>
                            <div class="font-bold text-emerald-700 font-mono">${{ reportStats.totalSales.toLocaleString() }}</div>
                        </div>
                        <div class="bg-blue-50 p-2 rounded-lg text-center border border-blue-100">
                            <div class="text-[10px] text-blue-600">é ä¼°ç§Ÿé‡‘æˆæœ¬</div>
                            <div class="font-bold text-blue-700 font-mono">${{ reportStats.totalRent.toLocaleString() }}</div>
                        </div>
                        <div class="bg-amber-50 p-2 rounded-lg text-center border border-amber-100">
                            <div class="text-[10px] text-amber-600">å¹³å‡å–®å ´æ¥­ç¸¾</div>
                            <div class="font-bold text-amber-700 font-mono">${{ reportStats.avgSales.toLocaleString() }}</div>
                        </div>
                    </div>
                </div>

                <div class="flex-grow overflow-y-auto custom-scroll bg-slate-50 p-4">
                    <div v-if="reportShifts.length === 0" class="text-center text-gray-400 mt-10">æ­¤å» å•†ç„¡æ’ç­è³‡æ–™</div>
                    <div v-else class="space-y-2">
                        <div v-for="shift in reportShifts" :key="shift.id" 
                             class="bg-white border rounded-lg p-3 flex flex-col md:flex-row gap-3 items-center shadow-sm transition-all"
                             :class="{'opacity-60 bg-gray-100': shift.status === 'leave'}">
                            
                            <div class="w-full md:w-32 flex justify-between md:block">
                                <div class="font-bold text-slate-700">{{ shift.date }}</div>
                                <div class="text-xs text-slate-500">{{ shift.station }}</div>
                            </div>

                            <div class="w-full md:w-32">
                                <select v-model="shift.status" @change="saveShift(shift)" class="w-full text-xs p-1.5 border rounded" :class="shift.status==='active'?'text-green-600':'text-red-500'">
                                    <option value="active">âœ… æ­£å¸¸å‡ºå¸­</option>
                                    <option value="leave">ğŸ›‘ è«‹å‡/å–æ¶ˆ</option>
                                </select>
                            </div>

                            <div class="flex-grow flex gap-2 w-full">
                                <div class="relative w-1/2">
                                    <span class="absolute left-2 top-1.5 text-gray-400 text-xs">$</span>
                                    <input type="number" v-model.lazy="shift.sales" @change="saveShift(shift)" placeholder="æ¥­ç¸¾" :disabled="shift.status==='leave'"
                                           class="w-full pl-5 p-1.5 border rounded text-sm font-mono focus:ring-2 focus:ring-emerald-500 outline-none">
                                </div>
                                <input type="text" v-model.lazy="shift.timeAdjustment" @change="saveShift(shift)" placeholder="å‚™è¨» (å¦‚: æ™šåˆ°)" 
                                       class="w-1/2 p-1.5 border rounded text-xs focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>

                            <button @click="deleteShift(shift)" class="text-gray-300 hover:text-red-500 px-2" title="åˆªé™¤æ’ç­">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <div v-if="showInput" class="fixed inset-0 bg-slate-900/90 z-[80] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-xl">
            <h3 class="font-bold text-lg mb-2">åŒ¯å…¥ CSV</h3>
            <textarea v-model="csvInput" class="w-full h-40 p-3 border rounded-lg font-mono text-xs mb-4 focus:ring-2 focus:ring-indigo-500" placeholder="Paste content here..."></textarea>
            <div class="flex justify-end gap-2">
                <button @click="showInput=false" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                <button @click="processCSV" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow-md hover:bg-indigo-700">è§£æè³‡æ–™</button>
            </div>
        </div>
    </div>

    <div v-if="showPKModal" class="fixed inset-0 bg-slate-900/80 z-[80] flex items-center justify-center p-4" @click.self="showPKModal=false">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-[70vh]">
            <div class="p-4 bg-gray-50 border-b font-bold flex justify-between">
                <span>PK æˆ°æƒ…å®¤ ({{pkList.length}}/8)</span>
                <button @click="pkList=[]" class="text-xs text-red-500">æ¸…ç©º</button>
            </div>
            <div class="overflow-y-auto p-2 custom-scroll">
                <div v-for="v in sortedVendors" :key="v.id" class="flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer" @click="togglePK(v.id)">
                    <div class="w-4 h-4 border rounded mr-3 flex items-center justify-center" :class="pkList.includes(v.id) ? 'bg-indigo-600 border-indigo-600' : 'border-gray-300'">
                        <i v-if="pkList.includes(v.id)" class="fa-solid fa-check text-white text-[10px]"></i>
                    </div>
                    <div class="flex-grow">
                        <div class="font-bold text-sm text-gray-700">{{ v.displayName }}</div>
                        <div class="text-[10px] text-gray-400">{{ getShiftCount(v.id) }}å ´</div>
                    </div>
                    <div v-if="pkList.includes(v.id)" class="w-3 h-3 rounded-full" :class="getPKColorClass(v.id)"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

    const CloudService = {
        save: async (k, d) => new Promise(r => setTimeout(() => { localStorage.setItem('v99_'+k, JSON.stringify(d)); r(); }, 500)),
        load: async (k) => new Promise(r => { const d = localStorage.getItem('v99_'+k); r(d ? JSON.parse(d) : null); })
    };

    createApp({
        setup() {
            // State
            const currentView = ref('kanban');
            const navItems = [
                { key: 'kanban', label: 'çœ‹æ¿', icon: 'fa-solid fa-columns' },
                { key: 'matrix', label: 'ç¸½è¡¨', icon: 'fa-solid fa-table-cells' },
                { key: 'analysis', label: 'åˆ†æ', icon: 'fa-solid fa-chart-line' },
                { key: 'vendor', label: 'å» å•†', icon: 'fa-solid fa-store' },
                { key: 'settings', label: 'è¨­å®š', icon: 'fa-solid fa-toolbox' }
            ];
            const mobileMenuOpen = ref(false);
            const showInput = ref(false);
            const csvInput = ref('');
            const isSaving = ref(false);
            const showPKModal = ref(false);
            const pkList = ref([]);
            const vendorSearch = ref('');
            const exportText = ref('');
            
            // New Shift State
            const manualShift = ref({
                date: new Date().toISOString().slice(0,10),
                drawer: 'é›™é€£',
                station: '',
                vendorId: ''
            });

            // Data
            const schedules = ref([]);
            const vendorList = ref([]);
            
            // Performance Modal State
            const salesReportModal = ref({ open: false, vendorId: '' });

            // --- Core Logic ---
            const getShiftCount = (vid) => schedules.value.filter(s => s.vendorId === vid).length;
            
            // Sorting Logic: Sort vendors by shift count descending for list
            const sortedVendors = computed(() => {
                return [...vendorList.value].sort((a,b) => getShiftCount(b.id) - getShiftCount(a.id));
            });
            
            // Filtered Vendors for Search in Vendor View
            const filteredVendors = computed(() => {
                const term = vendorSearch.value.toLowerCase();
                if (!term) return sortedVendors.value;
                return sortedVendors.value.filter(v => 
                    v.displayName.toLowerCase().includes(term) || 
                    v.aliases.some(a => a.toLowerCase().includes(term))
                );
            });

            // Set Default Vendor Logic
            const setDefaultVendor = () => {
                const goat = vendorList.value.find(v => v.displayName.includes('äº”å¯®å°–'));
                if (goat) {
                    salesReportModal.value.vendorId = goat.id;
                } else if (sortedVendors.value.length > 0) {
                    salesReportModal.value.vendorId = sortedVendors.value[0].id;
                }
            };

            const processCSV = async () => {
                if (!csvInput.value) return;
                const parsed = Papa.parse(csvInput.value, { header: false, skipEmptyLines: true });
                const rows = parsed.data;
                const newSchedules = [];
                const colMap = {};
                if (rows.length > 1) {
                    rows[0].forEach((c, i) => { if(i>0){const m=c.match(/(\d{1,2})\/(\d{1,2})/);if(m)colMap[i]=`${parseInt(m[1])>=11?2025:2026}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}`}});
                    for (let i=1; i<rows.length; i++) {
                        const row = rows[i]; if(!row[0]) continue;
                        let drawer = row[0].includes('é›™é€£')?'é›™é€£':row[0].includes('å£«æ—')?'å£«æ—':'çŸ³ç‰Œ';
                        row.forEach((cell, idx) => {
                            if(idx>0 && colMap[idx] && cell.trim()) {
                                cell.split(/[,ï¼Œã€]/).forEach(raw => {
                                    if(raw.trim()) newSchedules.push({id:crypto.randomUUID(), date:colMap[idx], drawer, station:row[0], rawStaff:raw.trim(), status:'active', sales:0, timeAdjustment:''});
                                });
                            }
                        });
                    }
                    schedules.value = newSchedules;
                    // Sync Vendors
                    const rawNames = [...new Set(newSchedules.map(s=>s.rawStaff))];
                    rawNames.forEach(r => {
                        if(!vendorList.value.some(v=>v.aliases.includes(r))) vendorList.value.push({id:crypto.randomUUID().substring(0,8), displayName:r, aliases:[r], category:''});
                    });
                    linkVendors();
                    showInput.value=false;
                    await saveAll();
                    setDefaultVendor();
                }
            };

            // NEW: Add Manual Shift
            const addManualShift = async () => {
                if(!manualShift.value.date || !manualShift.value.station || !manualShift.value.vendorId) {
                    Swal.fire('æ¬„ä½æœªå¡«', 'è«‹å¡«å¯«å®Œæ•´æ—¥æœŸã€ç«™é»èˆ‡å» å•†', 'warning');
                    return;
                }
                
                const vendor = vendorList.value.find(v => v.id === manualShift.value.vendorId);
                const rawName = vendor ? vendor.displayName : 'Unknown';

                schedules.value.push({
                    id: crypto.randomUUID(),
                    date: manualShift.value.date,
                    drawer: manualShift.value.drawer,
                    station: manualShift.value.station,
                    vendorId: manualShift.value.vendorId,
                    rawStaff: rawName,
                    status: 'active',
                    sales: 0,
                    timeAdjustment: ''
                });

                await saveAll();
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'æ’ç­å·²æ–°å¢', showConfirmButton: false, timer: 1500 });
                
                // Reset minimal fields
                manualShift.value.station = ''; 
                // Keep date/drawer/vendor as user might add multiple similar shifts
            };

            // NEW: Generate Export
            const generateExport = () => {
                const data = schedules.value.map(s => {
                    const v = vendorList.value.find(vn => vn.id === s.vendorId);
                    return {
                        Date: s.date,
                        Area: s.drawer,
                        Station: s.station,
                        Vendor: v ? v.displayName : s.rawStaff,
                        Status: s.status,
                        Sales: s.sales,
                        Note: s.timeAdjustment
                    };
                }).sort((a,b) => new Date(a.Date) - new Date(b.Date));

                exportText.value = Papa.unparse(data);
            };

            const copyExport = () => {
                navigator.clipboard.writeText(exportText.value);
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', showConfirmButton: false, timer: 1500 });
            };

            const linkVendors = () => schedules.value.forEach(s => { const v = vendorList.value.find(vn => vn.aliases.includes(s.rawStaff)); if(v) s.vendorId = v.id; });
            const saveAll = async () => { isSaving.value=true; await CloudService.save('s', schedules.value); await CloudService.save('v', vendorList.value); isSaving.value=false; };

            // --- Analysis ---
            const financialSummary = computed(() => {
                let p1=0, p2=0;
                analysisStats.value.forEach(s => { p1+=s.p1Rent.total; p2+=s.p2Rent.total; });
                return { p1Total:p1, p2Total:p2, growth: p1>0 ? Math.round(((p2-p1)/p1)*100) : 0 };
            });

            const analysisStats = computed(() => {
                return vendorList.value.map(v => {
                    const shifts = schedules.value.filter(s => s.vendorId===v.id && s.status!=='leave');
                    const p1S = shifts.filter(s => [11,12,1].includes(parseInt(s.date.split('-')[1])));
                    const p2S = shifts.filter(s => [2,3,4].includes(parseInt(s.date.split('-')[1])));
                    
                    const calcRent = (cnt) => { const base=cnt*800; const disc=cnt>=20?0.85:cnt>=10?0.9:1; return {total:Math.round(base*disc), discount:disc}; };
                    
                    const getDist = (list) => {
                        const t = list.length || 1;
                        return { 
                            sl: Math.round(list.filter(s=>s.drawer==='é›™é€£').length/t*100),
                            slin: Math.round(list.filter(s=>s.drawer==='å£«æ—').length/t*100),
                            sp: Math.round(list.filter(s=>s.drawer==='çŸ³ç‰Œ').length/t*100)
                        };
                    };

                    return {
                        name: v.displayName, category: v.category,
                        p1Count: p1S.length, p1Rent: calcRent(p1S.length), p1Dist: getDist(p1S),
                        p2Count: p2S.length, p2Rent: calcRent(p2S.length), p2Dist: getDist(p2S),
                        growth: p1S.length>0 ? Math.round(((p2S.length-p1S.length)/p1S.length)*100) : 0
                    };
                }).filter(s => s.p1Count+s.p2Count > 0).sort((a,b) => (b.p1Count+b.p2Count) - (a.p1Count+a.p2Count));
            });

            const platformInsights = computed(() => {
                // Top 3 by Station
                const stations = drawers.map(d => {
                    const stationShifts = schedules.value.filter(s => s.drawer === d.key && s.status !== 'leave');
                    const counts = {};
                    stationShifts.forEach(s => { 
                        const name = getDisplayStaff(s); 
                        counts[name] = (counts[name]||0)+1; 
                    });
                    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([n,c])=>({name:n, count:c}));
                    return { name: d.name, color: d.colorClass, top3: sorted };
                });

                // Category Balance
                const activeShifts = schedules.value.filter(s => s.status !== 'leave');
                const total = activeShifts.length || 1;
                const catCounts = {};
                activeShifts.forEach(s => {
                    const v = vendorList.value.find(vn=>vn.id===s.vendorId);
                    const cat = (v && v.category) ? v.category : 'æœªåˆ†é¡';
                    catCounts[cat] = (catCounts[cat]||0)+1;
                });
                const categories = Object.entries(catCounts)
                    .map(([n,c])=>({name:n, count:c, pct:Math.round(c/total*100)}))
                    .sort((a,b)=>b.count-a.count);

                return { stations, categories };
            });

            // --- Reporting Modal Logic ---
            const openPerformanceModal = () => {
                salesReportModal.value.open = true;
                if(!salesReportModal.value.vendorId) setDefaultVendor();
            };
            
            const reportShifts = computed(() => {
                if(!salesReportModal.value.vendorId) return [];
                return schedules.value
                    .filter(s => s.vendorId === salesReportModal.value.vendorId)
                    .sort((a,b) => new Date(a.date) - new Date(b.date));
            });

            const reportStats = computed(() => {
                const active = reportShifts.value.filter(s => s.status === 'active');
                const totalSales = active.reduce((sum, s) => sum + (parseInt(s.sales)||0), 0);
                const count = active.length;
                const discount = count >= 20 ? 0.85 : count >= 10 ? 0.9 : 1;
                const totalRent = Math.round(count * 800 * discount);
                return { totalSales, totalRent, avgSales: count > 0 ? Math.round(totalSales / count) : 0 };
            });

            const saveShift = async (shift) => await saveAll();
            
            const deleteShift = async (shift) => {
                if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­è¡¨ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                    schedules.value = schedules.value.filter(s => s.id !== shift.id);
                    await saveAll();
                }
            };
            
            // --- Vendor Actions ---
            const addNewVendor = () => vendorList.value.unshift({id:crypto.randomUUID().substring(0,8), displayName:'æ–°å» å•†', aliases:[], category:''});
            const addAlias = async (v) => { const {value} = await Swal.fire({input:'text', title:'æ–°å¢åˆ¥å(CSVå°ç…§ç”¨)'}); if(value) { v.aliases.push(value); linkVendors(); await saveAll(); } };
            const removeAlias = async (v,a) => { v.aliases = v.aliases.filter(x=>x!==a); await saveAll(); };
            const deleteVendor = async (vid) => {
                if(confirm('ç¢ºå®šåˆªé™¤æ­¤å» å•†ï¼Ÿé€™ä¸æœƒåˆªé™¤ç­è¡¨ï¼Œä½†æœƒè§£é™¤ç­è¡¨èˆ‡æ­¤å» å•†çš„é—œè¯ã€‚')) {
                    vendorList.value = vendorList.value.filter(v => v.id !== vid);
                    await saveAll();
                }
            };
            const simulateVendorLogin = (vendor) => {
                salesReportModal.value.vendorId = vendor.id;
                salesReportModal.value.open = true;
                Swal.fire({
                    toast: true, position: 'top-end', icon: 'success', 
                    title: `æ¨¡æ“¬ç™»å…¥: ${vendor.displayName}`, showConfirmButton: false, timer: 2000 
                });
            };

            // --- Helpers (Views) ---
            const drawers = [{key:'é›™é€£',name:'é›™é€£',colorClass:'bg-blue-500'},{key:'å£«æ—',name:'å£«æ—',colorClass:'bg-emerald-500'},{key:'çŸ³ç‰Œ',name:'çŸ³ç‰Œ',colorClass:'bg-amber-500'}];
            const getDisplayStaff = (s) => { const v = vendorList.value.find(vn => vn.id === s.vendorId); return v ? v.displayName : s.rawStaff; };
            const getShifts = (d,k) => schedules.value.filter(s => s.date===d && s.drawer===k);
            const getDrawerShiftCount = (k) => schedules.value.filter(s => s.drawer===k).length;
            const truncateName = (n) => n.length > 4 ? n.substring(0,3)+'..' : n;
            const handleSyncScroll = (e) => document.querySelectorAll('.sync-scroll-target').forEach(el => el.scrollTop = e.target.scrollTop);
            const getPKColorClass = (vid) => { const idx = pkList.value.indexOf(vid); return idx===-1?'':`pk-${idx}`; };
            const togglePK = (vid) => {
                const idx = pkList.value.indexOf(vid);
                if(idx > -1) pkList.value.splice(idx,1);
                else if(pkList.value.length < 8) pkList.value.push(vid);
            };
            const openShiftDetail = (shift) => { salesReportModal.value.vendorId = shift.vendorId; salesReportModal.value.open = true; };
            
            // Matrix Data
            const calendarWeeks = computed(() => {
                const dates = [...new Set(schedules.value.map(s=>s.date))].sort(); if(dates.length===0) return [];
                const start=new Date(dates[0]); start.setDate(start.getDate()-(start.getDay()===0?6:start.getDay()-1));
                const end=new Date(dates[dates.length-1]);
                const w=[]; let c=new Date(start); let lm=-1;
                while(c<=end){
                    const d=[]; let l=''; let im=false;
                    for(let i=0;i<5;i++){
                        const ds=c.toISOString().slice(0,10); const m=c.getMonth()+1;
                        if(m!==lm && i===0){l=`${c.getFullYear()}/${m}`; im=true; lm=m;}
                        d.push({dateStr:ds, dayNum:c.getDate(), weekday:['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][c.getDay()], isToday:new Date().toISOString().slice(0,10)===ds});
                        c.setDate(c.getDate()+1);
                    }
                    w.push({id:w.length, monthLabel:l, isMonthStart:im, days:d}); c.setDate(c.getDate()+2);
                }
                return w;
            });
            const matrixHeaders = computed(() => [...new Set(schedules.value.map(s => s.date))].sort().map(d => ({ simpleDate: d.substring(5).replace('-','/'), dayName: `(${new Date(d).toLocaleDateString('zh-TW',{weekday:'short'})})`, date: d })));
            const matrixGroups = computed(() => {
                const grps = [];
                drawers.forEach(dr => {
                    const st = [...new Set(schedules.value.filter(s => s.drawer===dr.key).map(s => s.station))];
                    const rows = st.map(station => ({
                        station, isShilin: dr.key==='å£«æ—',
                        cells: matrixHeaders.value.map(h => {
                            const m = schedules.value.find(s => s.date === h.date && s.station === station);
                            return m ? { name: getDisplayStaff(m), status: m.status, vendorId: m.vendorId, shift: m } : null;
                        })
                    }));
                    if(rows.length) grps.push({name: dr.name, rows, badgeClass: dr.colorClass});
                });
                return grps;
            });

            onMounted(async () => {
                const s = await CloudService.load('s'); const v = await CloudService.load('v');
                if(s) schedules.value = s; if(v) vendorList.value = v;
                linkVendors();
                setDefaultVendor();
            });

            return {
                currentView, mobileMenuOpen, navItems, isSaving, showInput, csvInput, showPKModal, pkList, salesReportModal,
                drawers, getDrawerShiftCount, calendarWeeks, getShifts, getDisplayStaff, truncateName, getPKColorClass, handleSyncScroll,
                matrixHeaders, matrixGroups, openShiftDetail,
                analysisStats, financialSummary, platformInsights,
                sortedVendors, filteredVendors, vendorSearch, reportShifts, reportStats, saveShift, deleteShift, openPerformanceModal, togglePK,
                addNewVendor, addAlias, removeAlias, deleteVendor, simulateVendorLogin, processCSV, getShiftCount,
                manualShift, addManualShift, exportText, generateExport, copyExport
            };
        }
    }).mount('#app');
</script>
</body>
</html>